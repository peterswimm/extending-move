{% extends "base.html" %}

{% block title %}M8C Display{% endblock %}

{% block head %}
<link rel="manifest" href="/static/m8c/manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    #m8c-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        background: #1a1a1a;
        min-height: calc(100vh - 60px);
    }
    
    #display-canvas {
        background: #000;
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
        border: 2px solid #333;
        cursor: crosshair;
        touch-action: none;
    }
    
    .controls {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .control-btn {
        padding: 10px 20px;
        background: #2a2a2a;
        color: #fff;
        border: 1px solid #444;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }
    
    .control-btn:hover {
        background: #3a3a3a;
    }
    
    .control-btn:active,
    .control-btn.pressed {
        background: #4a4a4a;
        transform: translateY(1px);
    }
    
    .status-bar {
        width: 100%;
        max-width: 640px;
        padding: 10px;
        background: #2a2a2a;
        border-radius: 4px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .status-indicator.connected {
        background: #4caf50;
        animation: pulse 2s infinite;
    }
    
    .status-indicator.disconnected {
        background: #f44336;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .device-selector {
        margin-bottom: 20px;
        padding: 15px;
        background: #2a2a2a;
        border-radius: 4px;
        width: 100%;
        max-width: 640px;
    }
    
    .device-selector select {
        width: 100%;
        padding: 8px;
        background: #1a1a1a;
        color: #fff;
        border: 1px solid #444;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    
    .keyboard-controls {
        display: grid;
        grid-template-columns: repeat(3, 60px);
        gap: 5px;
        margin-top: 20px;
    }
    
    .key-btn {
        width: 60px;
        height: 60px;
        background: #2a2a2a;
        color: #fff;
        border: 1px solid #444;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        user-select: none;
        -webkit-user-select: none;
    }
    
    .key-btn:active,
    .key-btn.pressed {
        background: #4a4a4a;
        border-color: #666;
    }
    
    .key-btn.key-empty {
        visibility: hidden;
    }
    
    #recording-indicator {
        color: #f44336;
        font-weight: bold;
        display: none;
    }
    
    #recording-indicator.active {
        display: inline;
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
    }
    
    .fullscreen-btn {
        position: fixed;
        top: 70px;
        right: 10px;
        z-index: 1000;
        background: #2a2a2a;
        color: #fff;
        border: 1px solid #444;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
    }
    
    @media (max-width: 768px) {
        .keyboard-controls {
            grid-template-columns: repeat(3, 50px);
        }
        
        .key-btn {
            width: 50px;
            height: 50px;
            font-size: 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="m8c-container">
    <button class="fullscreen-btn" onclick="toggleFullscreen()">⛶</button>
    
    <div class="status-bar">
        <div>
            <span class="status-indicator" id="connection-status"></span>
            <span id="connection-text">Disconnected</span>
        </div>
        <div>
            <span id="recording-indicator">● REC</span>
            <span id="device-info"></span>
        </div>
    </div>
    
    <div class="device-selector" id="device-selector">
        <label for="device-select">Select M8 Device:</label>
        <select id="device-select">
            <option value="">-- Select Device --</option>
            {% for device in devices %}
            <option value="{{ device.path }}">{{ device.description }} ({{ device.path }})</option>
            {% endfor %}
        </select>
        <button class="control-btn" onclick="connectDevice()">Connect</button>
        <button class="control-btn" onclick="refreshDevices()">Refresh</button>
    </div>
    
    <canvas id="display-canvas"></canvas>
    
    <div class="controls">
        <button class="control-btn" onclick="toggleConnection()">
            <span id="connect-btn-text">Connect</span>
        </button>
        <button class="control-btn" onclick="toggleRecording()">
            <span id="record-btn-text">Start Recording</span>
        </button>
        <button class="control-btn" onclick="changeScale()">Scale</button>
        <button class="control-btn" onclick="clearDisplay()">Clear</button>
    </div>
    
    <div class="keyboard-controls">
        <div class="key-btn key-empty"></div>
        <div class="key-btn" data-key="up">↑</div>
        <div class="key-btn key-empty"></div>
        <div class="key-btn" data-key="left">←</div>
        <div class="key-btn" data-key="play">▶</div>
        <div class="key-btn" data-key="right">→</div>
        <div class="key-btn" data-key="shift">⇧</div>
        <div class="key-btn" data-key="down">↓</div>
        <div class="key-btn" data-key="option">⌥</div>
        <div class="key-btn key-empty"></div>
        <div class="key-btn" data-key="edit">✎</div>
        <div class="key-btn key-empty"></div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="/static/m8c/renderer.js"></script>
<script src="/static/m8c/app.js"></script>
<script>
    // Initialize M8C display
    const m8cApp = new M8CApp();
    
    function toggleConnection() {
        m8cApp.toggleConnection();
    }
    
    function connectDevice() {
        const select = document.getElementById('device-select');
        if (select.value) {
            m8cApp.connect(select.value);
        }
    }
    
    function refreshDevices() {
        fetch('/api/m8c/devices')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('device-select');
                select.innerHTML = '<option value="">-- Select Device --</option>';
                data.devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.path;
                    option.textContent = `${device.description} (${device.path})`;
                    select.appendChild(option);
                });
            });
    }
    
    function toggleRecording() {
        m8cApp.toggleRecording();
    }
    
    function changeScale() {
        m8cApp.changeScale();
    }
    
    function clearDisplay() {
        m8cApp.clearDisplay();
    }
    
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.getElementById('m8c-container').requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    }
    
    // Keyboard event handlers
    document.addEventListener('keydown', (e) => {
        m8cApp.handleKeyDown(e);
    });
    
    document.addEventListener('keyup', (e) => {
        m8cApp.handleKeyUp(e);
    });
    
    // Touch event handlers for on-screen buttons
    document.querySelectorAll('.key-btn').forEach(btn => {
        const key = btn.dataset.key;
        if (!key) return;
        
        // Mouse events
        btn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            btn.classList.add('pressed');
            m8cApp.sendInput(key, true);
        });
        
        btn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            btn.classList.remove('pressed');
            m8cApp.sendInput(key, false);
        });
        
        btn.addEventListener('mouseleave', (e) => {
            btn.classList.remove('pressed');
            m8cApp.sendInput(key, false);
        });
        
        // Touch events
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            btn.classList.add('pressed');
            m8cApp.sendInput(key, true);
        });
        
        btn.addEventListener('touchend', (e) => {
            e.preventDefault();
            btn.classList.remove('pressed');
            m8cApp.sendInput(key, false);
        });
    });
    
    // Service worker registration for PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/m8c/service-worker.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker registration failed'));
    }
</script>
{% endblock %}